{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://stewardtrack.dev/schema/canonical-page-definition.json",
  "title": "CanonicalPageDefinition",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "contentVersion", "checksum", "kind", "layer", "page"],
  "properties": {
    "schemaVersion": { "type": "string" },
    "contentVersion": { "type": "string" },
    "checksum": { "type": "string" },
    "kind": { "type": "string", "enum": ["blueprint", "overlay"] },
    "layer": { "$ref": "#/definitions/layer" },
    "page": { "$ref": "#/definitions/page" },
    "sourcePath": { "type": "string" }
  },
  "definitions": {
    "layer": {
      "type": "object",
      "additionalProperties": false,
      "required": ["module", "route"],
      "properties": {
        "module": { "type": "string" },
        "route": { "type": "string" },
        "tenant": { "type": ["string", "null"], "default": null },
        "role": { "type": ["string", "null"], "default": null },
        "variant": { "type": ["string", "null"], "default": null },
        "locale": { "type": ["string", "null"], "default": null }
      }
    },
    "page": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string" },
        "title": { "type": "string" },
        "regions": {
          "type": "array",
          "items": { "$ref": "#/definitions/region" }
        },
        "components": {
          "type": "array",
          "items": { "$ref": "#/definitions/component" }
        },
        "dataSources": {
          "type": "array",
          "items": { "$ref": "#/definitions/dataSource" }
        },
        "actions": {
          "type": "array",
          "items": { "$ref": "#/definitions/action" }
        }
      }
    },
    "rbac": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "allow": {
          "type": "array",
          "items": { "type": "string" }
        },
        "deny": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "propValueStatic": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "value"],
      "properties": {
        "kind": { "const": "static" },
        "value": {}
      }
    },
    "propValueBinding": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "source"],
      "properties": {
        "kind": { "const": "binding" },
        "source": { "type": "string" },
        "path": { "type": ["string", "null"], "default": null },
        "fallback": {}
      }
    },
    "propValueExpression": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "expression"],
      "properties": {
        "kind": { "const": "expression" },
        "expression": { "type": "string" },
        "fallback": {}
      }
    },
    "propValueAction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "actionId"],
      "properties": {
        "kind": { "const": "action" },
        "actionId": { "type": "string" }
      }
    },
    "propValue": {
      "oneOf": [
        { "$ref": "#/definitions/propValueStatic" },
        { "$ref": "#/definitions/propValueBinding" },
        { "$ref": "#/definitions/propValueExpression" },
        { "$ref": "#/definitions/propValueAction" }
      ]
    },
    "component": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id"],
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string" },
        "namespace": { "type": "string" },
        "version": { "type": "string" },
        "operation": { "type": "string", "enum": ["merge", "replace", "remove"] },
        "props": {
          "type": "object",
          "additionalProperties": { "$ref": "#/definitions/propValue" }
        },
        "children": {
          "type": "array",
          "items": { "$ref": "#/definitions/component" }
        },
        "rbac": { "$ref": "#/definitions/rbac" }
      }
    },
    "region": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id"],
      "properties": {
        "id": { "type": "string" },
        "operation": { "type": "string", "enum": ["merge", "replace", "remove"] },
        "components": {
          "type": "array",
          "items": { "$ref": "#/definitions/component" }
        }
      }
    },
    "dataSource": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "kind"],
      "properties": {
        "id": { "type": "string" },
        "kind": { "type": "string", "enum": ["static", "supabase", "http", "service"] },
        "operation": { "type": "string", "enum": ["merge", "replace", "remove"] },
        "config": { "type": "object" },
        "rbac": { "$ref": "#/definitions/rbac" }
      }
    },
    "action": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "kind"],
      "properties": {
        "id": { "type": "string" },
        "kind": { "type": "string" },
        "operation": { "type": "string", "enum": ["merge", "replace", "remove"] },
        "config": { "type": "object" },
        "rbac": { "$ref": "#/definitions/rbac" }
      }
    }
  },
  "allOf": [
    {
      "if": { "properties": { "kind": { "const": "blueprint" } } },
      "then": {
        "properties": {
          "page": {
            "required": ["id"],
            "properties": {
              "regions": { "minItems": 0 },
              "dataSources": { "minItems": 0 },
              "actions": { "minItems": 0 }
            }
          }
        }
      }
    }
  ]
}
