# Azure Pipeline for StewardTrack Web Application
# Builds web app and runs E2E tests
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  - for-q2-2026-release
  - main
  - master

pr:
  - for-q2-2026-release
  - main
  - master

variables:
  - group: StewardTrack-E2E-Secrets
  - name: CI
    value: 'true'
  - name: PLAYWRIGHT_TEST_BASE_URL
    value: 'http://localhost:3000'
  - name: PNPM_STORE_PATH
    value: $(Pipeline.Workspace)/.pnpm-store
  - name: nodeVersion
    value: '20.x'

# ============================================
# Stage 1: Build Web Application
# ============================================
stages:
  - stage: BuildWeb
    displayName: 'Build Web Application'
    jobs:
      - job: WebBuild
        displayName: 'Build Next.js Web App'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: 'Install Node.js'

          - script: |
              npm install -g pnpm@9.15.0
            displayName: 'Install pnpm'

          - script: |
              mkdir -p $(PNPM_STORE_PATH)
              pnpm config set store-dir $(PNPM_STORE_PATH)
            displayName: 'Configure pnpm store'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: |
                pnpm | "$(Agent.OS)"
              path: $(PNPM_STORE_PATH)
            displayName: 'Cache pnpm packages'

          - script: pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm build:web
            displayName: 'Build web application'
            env:
              NEXT_PUBLIC_SUPABASE_URL: $(NEXT_PUBLIC_SUPABASE_URL)
              NEXT_PUBLIC_SUPABASE_ANON_KEY: $(NEXT_PUBLIC_SUPABASE_ANON_KEY)
              SUPABASE_SERVICE_ROLE_KEY: $(SUPABASE_SERVICE_ROLE_KEY)
              ENCRYPTION_MASTER_KEY: $(ENCRYPTION_MASTER_KEY)

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'apps/web/.next'
              artifact: 'web-build'
              publishLocation: 'pipeline'
            displayName: 'Publish web build artifact'

  # ============================================
  # Stage 2: Run E2E Tests
  # ============================================
  - stage: E2ETests
    displayName: 'E2E Tests'
    dependsOn: BuildWeb
    jobs:
      - job: PlaywrightTests
        displayName: 'Playwright E2E Tests'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: 'Install Node.js'

          - script: npm install -g pnpm@9.15.0
            displayName: 'Install pnpm'

          - script: |
              mkdir -p $(PNPM_STORE_PATH)
              pnpm config set store-dir $(PNPM_STORE_PATH)
            displayName: 'Configure pnpm store'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: |
                pnpm | "$(Agent.OS)"
              path: $(PNPM_STORE_PATH)
            displayName: 'Cache pnpm packages'

          - script: pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'current'
              artifactName: 'web-build'
              targetPath: 'apps/web/.next'
            displayName: 'Download web build'

          - script: cd apps/web && npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'

          - script: cd apps/web && npx playwright test --project=chromium
            displayName: 'Run Playwright E2E tests'
            env:
              CI: 'true'
              PLAYWRIGHT_TEST_BASE_URL: 'http://localhost:3000'
              NEXT_PUBLIC_SUPABASE_URL: $(NEXT_PUBLIC_SUPABASE_URL)
              NEXT_PUBLIC_SUPABASE_ANON_KEY: $(NEXT_PUBLIC_SUPABASE_ANON_KEY)
              SUPABASE_SERVICE_ROLE_KEY: $(SUPABASE_SERVICE_ROLE_KEY)
              ENCRYPTION_MASTER_KEY: $(ENCRYPTION_MASTER_KEY)

          - task: PublishTestResults@2
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'apps/web/test-results/junit.xml'
              testRunTitle: 'Playwright E2E Tests'
              mergeTestResults: true
            displayName: 'Publish test results'

          - task: PublishPipelineArtifact@1
            condition: failed()
            inputs:
              targetPath: 'apps/web/playwright-report'
              artifact: 'playwright-report'
              publishLocation: 'pipeline'
            displayName: 'Publish Playwright report on failure'
